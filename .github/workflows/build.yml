name: Picasso V2

on:
  workflow_call:
    inputs:
      STRAIN_REPOSITORY:
        description: 'The repository for strains to checkout. It should follow the format: ORGANIZATION/REPO'
        required: true
        type: string
      STRAIN_REPOSITORY_BRANCH:
        description: 'The branch of the repository to checkout'
        required: true
        type: string
      STRAIN_PATH:
        description: 'The path within the repository for strains'
        required: true
        type: string
      SERVICE:
        description: 'The service name to build'
        required: true
        type: string
      BUILDKIT_MAX_PARALLELISM:
        description: 'Enable buildkit parallelism limit to decrease resource usage. Default is true'
        required: false
        type: number
        default: 0
      RUNNER_WORKFLOW_LABEL:
        description: 'The label of the runner workflow to run'
        required: false
        type: string
        default: 'ubuntu-24.04'
      PYTHON_VERSION:
        description: 'Python version to use for the workflow'
        required: false
        type: string
        default: '3.12'
      PICASSO_VERSION:
        description: 'Picasso version to use for the workflow scripts and utility functions. This should be a valid branch, tag or commit and it should match the version of the workflow used.'
        required: false
        type: string
        default: 'v1'
      USE_DYNAMIC_IMAGE_TAG:
        description: 'If set to true, the image tag defined in config.yml will be ignored, and a dynamically generated tag will be used instead.'
        required: false
        type: boolean
        default: false
      UPDATE_IMAGE_TAG_IN_REPO:
        description: 'If this field is set to true, a commit will be created with the updated image tag name in the config.yml file'
        required: false
        type: boolean
        default: false
      ADD_RANDOM_SUFFIX_TO_IMAGE_TAG:
        description: 'Appends a random four-character alphanumeric suffix to the image tag by default. If RANDOM_SUFFIX_LENGTH is defined, the length of the suffix will be determined by that setting. This option is only used if USE_DYNAMIC_IMAGE_TAG is enabled.'
        required: false
        type: boolean
        default: false
      RANDOM_SUFFIX_LENGTH:
        description: 'Specifies the number of random characters to append as a random suffix'
        required: false
        type: string
        default: "4"
      IMAGE_TAG_PREFIX:
        description: 'Prefix added to the dynamically generated image tag. Only used if USE_DYNAMIC_IMAGE_TAG is enabled.'
        required: false
        type: string
        default: ""
      TIMESTAMP_FORMAT:
        description: 'Timestamp format used in the generated image tag. Follows Pythonâ€™s strftime syntax. Only used if USE_DYNAMIC_IMAGE_TAG is enabled.'
        required: false
        type: string
        default: "%Y%m%d-%H%M"
    secrets:
      DOCKERHUB_USERNAME:
        description: 'DockerHub username for login'
        required: false
      DOCKERHUB_PASSWORD:
        description: 'DockerHub password for login'
        required: false
      SSH_PRIVATE_KEY:
        description: 'Service user SSH key for repository checkout'
        required: true
      AWS_ACCESS_KEY_ID:
        description: 'AWS access key ID'
        required: false
      AWS_SECRET_ACCESS_KEY:
        description: 'AWS secret access key'
        required: false
      AWS_REGION:
        description: 'AWS region'
        required: false

jobs:
  build:
    runs-on: ${{ inputs.RUNNER_WORKFLOW_LABEL }}
    defaults:
      run:
        shell: bash
        working-directory: strains/${{ inputs.STRAIN_PATH }}
    env:
      TUTOR_ROOT: ${{ github.workspace }}/strains/${{ inputs.STRAIN_PATH }}
      TUTOR_PLUGINS_ROOT: ${{ github.workspace }}/strains/${{ inputs.STRAIN_PATH }}/plugins

    steps:
      - name: eox-manage
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          echo "$SSH_KEY"
